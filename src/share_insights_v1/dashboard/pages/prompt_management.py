import streamlit as st\nimport os\nfrom pathlib import Path\nfrom src.share_insights_v1.utils.prompt_loader import ThesisPromptLoader\n\ndef show_prompt_management():\n    \"\"\"Show prompt management interface for thesis generation\"\"\"\n    \n    st.title(\"üîß Prompt Management\")\n    st.markdown(\"*Manage and edit thesis generation prompt templates*\")\n    \n    # Initialize prompt loader\n    prompt_loader = ThesisPromptLoader()\n    \n    # Get available prompts\n    available_prompts = prompt_loader.list_available_prompts()
    
    # Add refresh button to clear cache
    if st.sidebar.button("üîÑ Refresh Prompts"):
        prompt_loader._prompt_cache.clear()
        available_prompts = prompt_loader.list_available_prompts()
        st.rerun()\n    \n    # Sidebar for prompt selection\n    st.sidebar.subheader(\"üìù Prompt Templates\")\n    selected_prompt = st.sidebar.selectbox(\n        \"Select Prompt Template:\",\n        available_prompts,\n        format_func=lambda x: {\n            'bull_case': 'üöÄ Bull Case',\n            'bear_case': 'üêª Bear Case', \n            'objective': '‚öñÔ∏è Objective',\n            'base': 'üìã Base Template'\n        }.get(x, x.replace('_', ' ').title())\n    )\n    \n    # Show prompt info\n    prompt_info = prompt_loader.get_prompt_info(selected_prompt)\n    if prompt_info:\n        st.sidebar.markdown(f\"**File:** {Path(prompt_info['file_path']).name}\")\n        st.sidebar.markdown(f\"**Size:** {prompt_info['file_size']:,} bytes\")\n    \n    # Main content area\n    col1, col2 = st.columns([3, 1])\n    \n    with col2:\n        st.subheader(\"üéõÔ∏è Actions\")\n        \n        if st.button(\"üì• Load Template\", use_container_width=True):\n            st.session_state.current_prompt = prompt_loader.load_prompt(selected_prompt)\n            st.session_state.selected_prompt_type = selected_prompt\n            st.success(f\"Loaded {selected_prompt} template\")\n        \n        if st.button(\"üíæ Save Changes\", use_container_width=True):\n            if 'edited_prompt' in st.session_state and 'selected_prompt_type' in st.session_state:\n                save_prompt_template(st.session_state.selected_prompt_type, st.session_state.edited_prompt)\n                st.success(\"Template saved successfully!\")\n            else:\n                st.error(\"No changes to save\")\n        \n        if st.button(\"üîÑ Reset to Default\", use_container_width=True):\n            if 'selected_prompt_type' in st.session_state:\n                # Clear cache and reload\n                prompt_loader._prompt_cache.clear()\n                st.session_state.current_prompt = prompt_loader.load_prompt(st.session_state.selected_prompt_type)\n                st.success(\"Reset to default template\")\n        \n        st.markdown(\"---\")\n        \n        # Template variables reference\n        st.subheader(\"üìã Template Variables\")\n        with st.expander(\"Available Variables\", expanded=False):\n            variables = [\n                \"{ticker}\", \"{company_type}\", \"{target_price}\", \"{current_price_str}\",\n                \"{market_cap}\", \"{pe_ratio}\", \"{revenue_growth}\", \"{strengths}\",\n                \"{risks}\", \"{industry_outlook}\", \"{news_count}\", \"{segment_info}\"\n            ]\n            for var in variables:\n                st.code(var, language=\"text\")\n    \n    with col1:\n        st.subheader(f\"‚úèÔ∏è Edit {selected_prompt.replace('_', ' ').title()} Template\")\n        \n        # Load current prompt if not already loaded\n        if 'current_prompt' not in st.session_state:\n            st.session_state.current_prompt = prompt_loader.load_prompt(selected_prompt)\n            st.session_state.selected_prompt_type = selected_prompt\n        \n        # Check if we switched prompt types\n        if st.session_state.get('selected_prompt_type') != selected_prompt:\n            st.session_state.current_prompt = prompt_loader.load_prompt(selected_prompt)\n            st.session_state.selected_prompt_type = selected_prompt\n        \n        # Text editor for prompt\n        edited_prompt = st.text_area(\n            \"Prompt Template:\",\n            value=st.session_state.current_prompt,\n            height=600,\n            help=\"Edit the prompt template. Use {variable_name} for dynamic content.\",\n            key=\"prompt_editor\"\n        )\n        \n        # Store edited prompt in session state\n        st.session_state.edited_prompt = edited_prompt\n        \n        # Show character count\n        char_count = len(edited_prompt)\n        word_count = len(edited_prompt.split())\n        st.caption(f\"üìä {word_count:,} words, {char_count:,} characters\")\n        \n        # Preview section\n        if st.button(\"üëÅÔ∏è Preview with Sample Data\"):\n            show_prompt_preview(edited_prompt, selected_prompt)\n\ndef save_prompt_template(prompt_type: str, content: str):\n    \"\"\"Save edited prompt template to file\"\"\"\n    \n    prompt_file_map = {\n        'bull_case': 'bull_case_prompt.txt',\n        'bear_case': 'bear_case_prompt.txt',\n        'objective': 'objective_case_prompt.txt',\n        'base': 'base_thesis_prompt.txt'\n    }\n    \n    if prompt_type not in prompt_file_map:\n        st.error(f\"Unknown prompt type: {prompt_type}\")\n        return\n    \n    # Get prompts directory\n    prompts_dir = Path(__file__).parent.parent / \"prompts\" / \"thesis_generation\"\n    prompt_file = prompts_dir / prompt_file_map[prompt_type]\n    \n    try:\n        # Create backup\n        backup_file = prompt_file.with_suffix('.txt.backup')\n        if prompt_file.exists():\n            backup_file.write_text(prompt_file.read_text(encoding='utf-8'), encoding='utf-8')\n        \n        # Save new content\n        prompt_file.write_text(content, encoding='utf-8')\n        \n        # Clear cache so changes take effect\n        prompt_loader = ThesisPromptLoader()\n        prompt_loader._prompt_cache.clear()\n        \n    except Exception as e:\n        st.error(f\"Failed to save template: {str(e)}\")\n\ndef show_prompt_preview(prompt_content: str, prompt_type: str):\n    \"\"\"Show preview of prompt with sample data\"\"\"\n    \n    st.subheader(\"üîç Prompt Preview\")\n    \n    # Sample data for preview\n    sample_data = {\n        'ticker': 'AAPL',\n        'company_type': 'Large Cap Technology',\n        'target_price': 185.50,\n        'current_price_str': '$175.25',\n        'market_cap': 2800000000000,\n        'enterprise_value': 2750000000000,\n        'beta': 1.25,\n        'pe_ratio': 28.5,\n        'ps_ratio': 7.2,\n        'pb_ratio': 12.8,\n        'ev_ebitda_multiple': 22.1,\n        'gross_margin': 0.43,\n        'operating_margin': 0.28,\n        'net_margin': 0.24,\n        'roe': 0.15,\n        'roa': 0.12,\n        'revenue_growth': 0.08,\n        'earnings_growth': 0.12,\n        'debt_to_equity': 1.73,\n        'current_ratio': 1.05,\n        'quick_ratio': 0.95,\n        'free_cash_flow': 95000000000,\n        'cash_per_share': 15.25,\n        'book_value_per_share': 4.85,\n        'dividend_yield': 0.0045,\n        'payout_ratio': 0.15,\n        'total_revenue': 394000000000,\n        'latest_net_income': 97000000000,\n        'latest_operating_income': 114000000000,\n        'latest_gross_profit': 170000000000,\n        'latest_operating_cf': 104000000000,\n        'latest_capital_expenditures': 11000000000,\n        'industry': 'Consumer Electronics',\n        'sector': 'Technology',\n        'segment_info': '\\n- iPhone: 52.4% of revenue\\n- Services: 22.3% of revenue\\n- Mac: 10.1% of revenue',\n        'net_income_growth': 5.8,\n        'operating_cf_growth': 7.2,\n        'dcf_calculation_details': '\\n\\n**DCF CALCULATION VALIDATION:**\\n- WACC: 8.5%\\n- FCF CAGR: 6.2%\\n- Terminal Growth: 2.5%',\n        'startup_calculation_details': '',\n        'average_target': 182.75,\n        'consensus_strength': 'High',\n        'method_agreement': '8/10 methods bullish',\n        'strengths': 'Strong brand loyalty, Ecosystem lock-in, Premium pricing power, Innovation pipeline, Cash generation',\n        'risks': 'China dependency, Regulatory scrutiny, Market saturation, Competition, Supply chain risks',\n        'key_developments': 'iPhone 15 launch success, Services growth acceleration, Vision Pro announcement',\n        'sentiment_rating': 'Positive',\n        'news_count': 15,\n        'news_sources_with_urls': 'Reuters: Apple reports strong Q4... (https://reuters.com/apple), Bloomberg: iPhone demand... (https://bloomberg.com/iphone)',\n        'industry_outlook': 'Positive',\n        'competitive_position': 'Strong',\n        'regulatory_risk': 'Medium',\n        'esg_score': 7.5,\n        'business_segments': 'iPhone, Services, Mac, iPad, Wearables',\n        'revenue_breakdown': 'iPhone (52.4%), Services (22.3%), Mac (10.1%), iPad (8.7%), Wearables (6.5%)',\n        'data_source': 'SEC 10-K Filing',\n        'revenue_diversification': 'Moderate',\n        'thesis_type_lower': prompt_type.replace('_', ' ').lower()\n    }\n    \n    try:\n        # Format prompt with sample data\n        formatted_prompt = prompt_content.format(**sample_data)\n        \n        # Display in expandable section\n        with st.expander(\"üìÑ Formatted Prompt Preview\", expanded=True):\n            st.markdown(\n                f\"\"\"\n                <div style=\"\n                    background-color: #f8f9fa;\n                    padding: 15px;\n                    border: 1px solid #dee2e6;\n                    border-radius: 5px;\n                    font-family: 'Courier New', monospace;\n                    font-size: 12px;\n                    line-height: 1.4;\n                    max-height: 400px;\n                    overflow-y: auto;\n                    white-space: pre-wrap;\n                \">\n                    {formatted_prompt}\n                </div>\n                \"\"\",\n                unsafe_allow_html=True\n            )\n        \n        # Show statistics\n        preview_word_count = len(formatted_prompt.split())\n        preview_char_count = len(formatted_prompt)\n        st.caption(f\"üìä Preview: {preview_word_count:,} words, {preview_char_count:,} characters\")\n        \n    except KeyError as e:\n        st.error(f\"Missing template variable: {e}\")\n        st.info(\"Make sure all variables in the template are defined in the sample data.\")\n    except Exception as e:\n        st.error(f\"Error formatting prompt: {str(e)}\")\n\ndef main():\n    \"\"\"Main function for prompt management page\"\"\"\n    show_prompt_management()\n\nif __name__ == \"__main__\":\n    main()